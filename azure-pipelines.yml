trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  imageRepository: 'myregistry.azurecr.io/demojava'
  dockerfilePath: 'Dockerfile'
  manifestsPath: 'k8s'

resources:
  repositories:
    - repository: githubRepo
      type: github
      name: Venkat-Expleo/demojava   # ðŸ‘ˆ change this
      endpoint: github-pat    



stages:
- stage: Build
  jobs:
  - job: Build
    steps:
    # - checkout: https://github.com/krdevops09/demojava.git
    #   endpoint: github-pat     # ðŸ‘ˆ Add your GitHub service connection here

    - task: Maven@3
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'package'
        options: '-DskipTests'

    - task: Docker@2
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        tags: |
          $(Build.BuildId)

- stage: Deploy
  dependsOn: Build
  jobs:
  - job: Deploy
    steps:
    - task: KubernetesManifest@1
      inputs:
        action: deploy
        manifests: $(manifestsPath)/*.yaml
        containers: |
          $(imageRepository):$(Build.BuildId)
